class RNNDemo{constructor(){this.inputCanvas=document.getElementById("input-canvas"),this.rnnCanvas=document.getElementById("rnn-canvas"),this.outputCanvas=document.getElementById("output-canvas"),this.inputCtx=this.inputCanvas.getContext("2d"),this.rnnCtx=this.rnnCanvas.getContext("2d"),this.outputCtx=this.outputCanvas.getContext("2d"),this.sequenceSelect=document.getElementById("sequence-select"),this.inputWeightSlider=document.getElementById("input-weight"),this.hiddenWeightSlider=document.getElementById("hidden-weight"),this.biasSlider=document.getElementById("bias"),this.activationSelect=document.getElementById("activation-select"),this.stepBtn=document.getElementById("step-btn"),this.resetBtn=document.getElementById("reset-btn"),this.inputWeightValue=document.getElementById("input-weight-value"),this.hiddenWeightValue=document.getElementById("hidden-weight-value"),this.biasValue=document.getElementById("bias-value"),this.timestepDisplay=document.getElementById("timestep-display"),this.hiddenStateDisplay=document.getElementById("hidden-state-display"),this.outputDisplay=document.getElementById("output-display"),this.setupHighDPICanvas(this.inputCanvas,this.inputCtx),this.setupHighDPICanvas(this.rnnCanvas,this.rnnCtx),this.setupHighDPICanvas(this.outputCanvas,this.outputCtx),this.sequences={fibonacci:[1,1,2,3,5],linear:[1,2,3,4,5],alternating:[1,-1,1,-1,1],exponential:[1,2,4,8,16],sine:[0,.5,1,.5,0]},this.reset(),this.setupEventListeners(),this.updateDisplay(),this.render()}setupHighDPICanvas(t,e){const i=window.devicePixelRatio||1,n=t.clientWidth||t.width,l=t.clientHeight||t.height;return t.width=n*i,t.height=l*i,t.style.width=n+"px",t.style.height=l+"px",e.scale(i,i),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",{displayWidth:n,displayHeight:l}}setupEventListeners(){this.inputWeightSlider.addEventListener("input",()=>{this.inputWeightValue.textContent=parseFloat(this.inputWeightSlider.value).toFixed(1),this.render()}),this.hiddenWeightSlider.addEventListener("input",()=>{this.hiddenWeightValue.textContent=parseFloat(this.hiddenWeightSlider.value).toFixed(1),this.render()}),this.biasSlider.addEventListener("input",()=>{this.biasValue.textContent=parseFloat(this.biasSlider.value).toFixed(1),this.render()}),this.sequenceSelect.addEventListener("change",()=>{this.reset(),this.render()}),this.activationSelect.addEventListener("change",()=>{this.render()}),this.stepBtn.addEventListener("click",()=>this.step()),this.resetBtn.addEventListener("click",()=>{this.reset(),this.render()})}reset(){this.currentTimestep=0,this.hiddenState=0,this.outputs=[],this.hiddenStates=[],this.currentSequence=this.sequences[this.sequenceSelect.value],this.updateDisplay()}step(){if(this.currentTimestep<this.currentSequence.length){const t=this.currentSequence[this.currentTimestep],e=parseFloat(this.inputWeightSlider.value),i=parseFloat(this.hiddenWeightSlider.value),n=parseFloat(this.biasSlider.value),l=e*t+i*this.hiddenState+n;this.hiddenState=this.applyActivation(l);const s=this.hiddenState;this.outputs.push(s),this.hiddenStates.push(this.hiddenState),this.currentTimestep++,this.updateDisplay(),this.render()}}applyActivation(t){switch(this.activationSelect.value){case"linear":default:return t;case"relu":return Math.max(0,t);case"sigmoid":return 1/(1+Math.exp(-t));case"tanh":return Math.tanh(t)}}updateDisplay(){this.timestepDisplay.textContent=this.currentTimestep,this.hiddenStateDisplay.textContent=this.hiddenState.toFixed(3);const t=this.outputs.length>0?this.outputs[this.outputs.length-1]:0;this.outputDisplay.textContent=t.toFixed(3)}render(){this.clearCanvases(),this.drawInputSequence(),this.drawRNNCell(),this.drawOutput()}clearCanvases(){const t=[this.inputCanvas,this.rnnCanvas,this.outputCanvas];[this.inputCtx,this.rnnCtx,this.outputCtx].forEach((e,i)=>{e.clearRect(0,0,t[i].clientWidth,t[i].clientHeight)})}drawInputSequence(){const t=this.inputCtx,e=this.inputCanvas,i=e.clientWidth,n=e.clientHeight,l=this.currentSequence,s=i/l.length,h=(n-60)/2;if(l.forEach((e,i)=>{const n=i*s+.1*s,a=h,r=.8*s;i===this.currentTimestep&&this.currentTimestep<l.length?(t.fillStyle="#ffd700",t.strokeStyle="#ff8c00",t.lineWidth=3):i<this.currentTimestep?(t.fillStyle="#e3f2fd",t.strokeStyle="#1976d2",t.lineWidth=2):(t.fillStyle="#f5f5f5",t.strokeStyle="#ccc",t.lineWidth=1),t.fillRect(n,a,r,60),t.strokeRect(n,a,r,60),t.fillStyle="#333",t.font="18px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(e.toString(),n+r/2,a+30),t.font="12px Arial",t.fillStyle="#666",t.fillText(`t=${i}`,n+r/2,a+60+15)}),this.currentTimestep<l.length){const e=this.currentTimestep*s+s/2,i=h-20;t.fillStyle="#ff6b6b",t.beginPath(),t.moveTo(e,i),t.lineTo(e-8,i-15),t.lineTo(e+8,i-15),t.closePath(),t.fill()}}drawRNNCell(){const t=this.rnnCtx,e=this.rnnCanvas,i=e.clientWidth/2,n=e.clientHeight/2,l=120,s=i-60,h=n-40;t.fillStyle="#f3e5f5",t.strokeStyle="#7b1fa2",t.lineWidth=3,t.fillRect(s,h,l,80),t.strokeRect(s,h,l,80),t.fillStyle="#333",t.font="bold 16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("RNN",i,n-15),t.font="14px Arial",t.fillText(`bias = ${this.biasSlider.value}`,i,n+5),t.fillText(`f = ${this.activationSelect.value}`,i,n+20);const a=i-150,r=n,d=25;t.fillStyle="#fff3e0",t.strokeStyle="#f57c00",t.lineWidth=3,t.beginPath(),t.arc(a,r,d,0,2*Math.PI),t.fill(),t.stroke(),t.fillStyle="#333",t.font="bold 16px Arial",t.textAlign="center",t.fillText("h",a-8,r),t.font="10px Arial",t.fillText("t-1",a+8,r+8);const o=this.hiddenStates.length>1?this.hiddenStates[this.hiddenStates.length-2]:0;t.font="13px Arial",t.fillStyle="#f57c00",t.fillText(o.toFixed(2),a,r+35);const c=i,u=n+100;if(t.fillStyle="#e3f2fd",t.strokeStyle="#1976d2",t.lineWidth=3,t.beginPath(),t.arc(c,u,d,0,2*Math.PI),t.fill(),t.stroke(),t.fillStyle="#333",t.font="bold 18px Arial",t.textAlign="center",t.fillText("x",c-6,u),t.font="11px Arial",t.fillText("t",c+6,u+6),this.currentTimestep>0&&this.currentTimestep<=this.currentSequence.length){const e=this.currentSequence[this.currentTimestep-1];t.font="13px Arial",t.fillStyle="#1976d2",t.fillText(e.toString(),c,u+35)}const p=i+150,f=n;t.fillStyle="#e8f5e8",t.strokeStyle="#388e3c",t.lineWidth=3,t.beginPath(),t.arc(p,f,d,0,2*Math.PI),t.fill(),t.stroke(),t.fillStyle="#333",t.font="bold 18px Arial",t.textAlign="center",t.fillText("h",p-6,f),t.font="11px Arial",t.fillText("t",p+6,f+6),t.font="13px Arial",t.fillStyle="#388e3c",t.fillText(this.hiddenState.toFixed(2),p,f+35),this.drawConnection(t,a+d,r,s,n,`W_{h}=${this.hiddenWeightSlider.value}`,"#f57c00",{x:(a+d+s)/2,y:n-15});const x=i+25,g=(u-d+h+80)/2;this.drawConnection(t,c,u-d,i,h+80,`W_{i}=${this.inputWeightSlider.value}`,"#1976d2",{x:x,y:g}),this.drawConnection(t,s+l,n,p-d,f,"","#388e3c")}drawConnection(t,e,i,n,l,s,h,a=null){t.strokeStyle=h,t.lineWidth=2,t.beginPath(),t.moveTo(e,i),t.lineTo(n,l),t.stroke();const r=Math.atan2(l-i,n-e);if(t.beginPath(),t.moveTo(n,l),t.lineTo(n-8*Math.cos(r-Math.PI/6),l-8*Math.sin(r-Math.PI/6)),t.lineTo(n-8*Math.cos(r+Math.PI/6),l-8*Math.sin(r+Math.PI/6)),t.closePath(),t.fillStyle=h,t.fill(),s){let r,d;a?(r=a.x,d=a.y):(r=(e+n)/2,d=(i+l)/2-5),t.fillStyle=h,this.drawMathLabel(t,s,r,d)}}drawMathLabel(t,e,i,n){if(e.includes("W_{h}=")){const l=e.split("=")[1];t.font="bold 12px Arial",t.textAlign="center",t.fillText("W",i-15,n),t.font="9px Arial",t.fillText("h",i-7,n+5),t.font="12px Arial",t.fillText("=",i+2,n),t.fillText(l,i+12,n)}else if(e.includes("W_{i}=")){const l=e.split("=")[1];t.font="bold 12px Arial",t.textAlign="center",t.fillText("W",i-15,n),t.font="9px Arial",t.fillText("i",i-7,n+5),t.font="12px Arial",t.fillText("=",i+2,n),t.fillText(l,i+12,n)}else t.font="12px Arial",t.textAlign="center",t.fillText(e,i,n)}drawOutput(){const t=this.outputCtx,e=this.outputCanvas,i=e.clientWidth,n=e.clientHeight;if(0===this.outputs.length)return;this.outputs;const l=i/this.currentSequence.length,s=(n-60)/2;this.outputs.forEach((e,i)=>{const n=i*l+.1*l,h=s,a=.8*l;t.fillStyle="#e8f5e8",t.strokeStyle="#388e3c",t.lineWidth=2,t.fillRect(n,h,a,60),t.strokeRect(n,h,a,60),t.fillStyle="#333",t.font="18px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(e.toFixed(2),n+a/2,h+30),t.font="12px Arial",t.fillStyle="#666",t.fillText(`t=${i}`,n+a/2,h+60+15)});for(let e=this.outputs.length;e<this.currentSequence.length;e++){const i=e*l+.1*l,n=s,h=.8*l,a=60;t.fillStyle="#f5f5f5",t.strokeStyle="#ccc",t.lineWidth=1,t.fillRect(i,n,h,a),t.strokeRect(i,n,h,a),t.font="12px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(`t=${e}`,i+h/2,n+a+15)}}}