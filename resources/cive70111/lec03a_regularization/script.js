class PolynomialRegularizationDemo{constructor(){this.canvas=document.getElementById("plot"),this.overlayCanvas=document.getElementById("overlay-canvas"),this.overlayCtx=this.overlayCanvas.getContext("2d"),this.chart=null,this.equation=document.getElementById("equation"),this.mseDisplay=document.getElementById("mse"),this.maeDisplay=document.getElementById("mae"),this.generateDataBtn=document.getElementById("generate-data-btn"),this.clearDataBtn=document.getElementById("clear-data-btn"),this.degreeSlider=document.getElementById("degree"),this.degreeValue=document.getElementById("degree-value"),this.l1RegSlider=document.getElementById("l1-reg"),this.l1Value=document.getElementById("l1-value"),this.l2RegSlider=document.getElementById("l2-reg"),this.l2Value=document.getElementById("l2-value"),this.showSquaresCheckbox=document.getElementById("show-squares"),this.xMin=-10,this.xMax=10,this.yMin=-100,this.yMax=100,this.generateTruePolynomial(),this.generateDataPoints(),this.coefficients=[],this.initializeChart(),this.setupHighDPIOverlayCanvas(),this.setupEventListeners(),this.initializeDisplay(),this.tabController=new DemoTabController}generateTruePolynomial(){this.trueCoefficients=[60*(Math.random()-.5),8*(Math.random()-.5),2*(Math.random()-.5),.4*(Math.random()-.5)]}generateDataPoints(){this.dataPoints=[];for(let i=0;i<5;i++){let x,y,attempts=0;do{x=18*(Math.random()-.5);y=this.trueCoefficients[0]+this.trueCoefficients[1]*x+this.trueCoefficients[2]*x*x+this.trueCoefficients[3]*x*x*x+8*(Math.random()-.5)*2,attempts++}while((y<this.yMin||y>this.yMax)&&attempts<50);attempts>=50&&(y=Math.max(this.yMin+10,Math.min(this.yMax-10,y))),this.dataPoints.push({x:x,y:y})}}setupHighDPIOverlayCanvas(){const dpr=window.devicePixelRatio||1,displayWidth=this.canvas.clientWidth,displayHeight=this.canvas.clientHeight;this.overlayCanvas.width=displayWidth*dpr,this.overlayCanvas.height=displayHeight*dpr,this.overlayCanvas.style.width=displayWidth+"px",this.overlayCanvas.style.height=displayHeight+"px",this.overlayCtx.scale(dpr,dpr),this.overlayCtx.imageSmoothingEnabled=!0,this.overlayCtx.imageSmoothingQuality="high",this.dpr=dpr,this.displayWidth=displayWidth,this.displayHeight=displayHeight,this.overlayCtx.clearRect(0,0,displayWidth,displayHeight)}initializeChart(){this.chart=new Chart(this.canvas.getContext("2d"),{type:"scatter",data:{datasets:[{label:"Data Points",data:[],backgroundColor:"#ff6b6b",borderColor:"#d63447",borderWidth:2,pointRadius:5,pointHoverRadius:7,showLine:!1},{label:"Polynomial Fit",data:[],backgroundColor:"transparent",borderColor:"#4ecdc4",borderWidth:2,pointRadius:0,pointHoverRadius:0,showLine:!0,fill:!1,tension:0,spanGaps:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",position:"center",min:this.xMin,max:this.xMax,title:{display:!0,text:"X"},grid:{color:"#e0e0e0"}},y:{type:"linear",position:"center",min:this.yMin,max:this.yMax,title:{display:!0,text:"Y"},grid:{color:"#e0e0e0"}}},plugins:{legend:{display:!0,position:"top"},tooltip:{filter:tooltipItem=>0===tooltipItem.datasetIndex}},onClick:(event,activeElements)=>{this.handleChartClick(event)},animation:{duration:0}}})}initializeDisplay(){this.updateDegreeDisplay(),this.updateRegularizationDisplay(),this.fitPolynomial(),this.updateChart(),this.updateDisplayPlainText(),window.MathJax&&(MathJax.startup&&MathJax.startup.promise?MathJax.startup.promise.then(()=>{this.updateDisplay()}).catch(()=>{console.warn("MathJax failed to load, using plain text equations")}):setTimeout(()=>{this.updateDisplay()},100))}getSelectedPowers(){const degree=parseInt(this.degreeSlider.value),selectedPowers=[];for(let i=0;i<=degree;i++)selectedPowers.push(i);return selectedPowers}updateDegreeDisplay(){const degree=parseInt(this.degreeSlider.value);this.degreeValue.textContent=degree.toString()}updateRegularizationDisplay(){const l1=parseFloat(this.l1RegSlider.value),l2=parseFloat(this.l2RegSlider.value);this.l1Value.textContent=l1.toFixed(1),this.l2Value.textContent=l2.toFixed(1)}createDesignMatrix(dataPoints,powers){const n=dataPoints.length,p=powers.length,X=[];for(let i=0;i<n;i++){const row=[],x=dataPoints[i].x;for(let j=0;j<p;j++){const power=powers[j];row.push(Math.pow(x,power))}X.push(row)}return X}fitPolynomial(){if(0===this.dataPoints.length)return void(this.coefficients=[]);const selectedPowers=this.getSelectedPowers();if(0===selectedPowers.length)return void(this.coefficients=[]);const X=this.createDesignMatrix(this.dataPoints,selectedPowers),y=this.dataPoints.map(point=>point.y),l1Lambda=parseFloat(this.l1RegSlider.value),l2Lambda=parseFloat(this.l2RegSlider.value);try{this.coefficients=this.solveRegularizedNormalEquations(X,y,l1Lambda,l2Lambda),this.selectedPowers=selectedPowers}catch(error){console.warn("Matrix inversion failed, using zero coefficients"),this.coefficients=new Array(selectedPowers.length).fill(0),this.selectedPowers=selectedPowers}}solveNormalEquations(X,y){const n=X.length,p=X[0].length,XT=[];for(let i=0;i<p;i++){const row=[];for(let j=0;j<n;j++)row.push(X[j][i]);XT.push(row)}const XTX=[];for(let i=0;i<p;i++){const row=[];for(let j=0;j<p;j++){let sum=0;for(let k=0;k<n;k++)sum+=XT[i][k]*X[k][j];row.push(sum)}XTX.push(row)}const XTy=[];for(let i=0;i<p;i++){let sum=0;for(let j=0;j<n;j++)sum+=XT[i][j]*y[j];XTy.push(sum)}return this.gaussianElimination(XTX,XTy)}gaussianElimination(A,b){const n=A.length,augmented=[];for(let i=0;i<n;i++)augmented.push([...A[i],b[i]]);for(let i=0;i<n;i++){let maxRow=i;for(let k=i+1;k<n;k++)Math.abs(augmented[k][i])>Math.abs(augmented[maxRow][i])&&(maxRow=k);[augmented[i],augmented[maxRow]]=[augmented[maxRow],augmented[i]];for(let k=i+1;k<n;k++){if(Math.abs(augmented[i][i])<1e-10)continue;const c=augmented[k][i]/augmented[i][i];for(let j=i;j<=n;j++)augmented[k][j]-=c*augmented[i][j]}}const x=new Array(n).fill(0);for(let i=n-1;i>=0;i--){x[i]=augmented[i][n];for(let j=i+1;j<n;j++)x[i]-=augmented[i][j]*x[j];Math.abs(augmented[i][i])>1e-10&&(x[i]/=augmented[i][i])}return x}solveRegularizedNormalEquations(X,y,l1Lambda,l2Lambda){return 0===l1Lambda?this.solveRidgeRegression(X,y,l2Lambda):this.solveElasticNet(X,y,l1Lambda,l2Lambda)}solveRidgeRegression(X,y,l2Lambda){const n=X.length,p=X[0].length,XT=[];for(let i=0;i<p;i++){const row=[];for(let j=0;j<n;j++)row.push(X[j][i]);XT.push(row)}const XTX=[];for(let i=0;i<p;i++){const row=[];for(let j=0;j<p;j++){let sum=0;for(let k=0;k<n;k++)sum+=XT[i][k]*X[k][j];i===j&&(sum+=l2Lambda),row.push(sum)}XTX.push(row)}const XTy=[];for(let i=0;i<p;i++){let sum=0;for(let j=0;j<n;j++)sum+=XT[i][j]*y[j];XTy.push(sum)}return this.gaussianElimination(XTX,XTy)}solveElasticNet(X,y,l1Lambda,l2Lambda){const n=X.length,p=X[0].length;let coefficients=new Array(p).fill(0);for(let iter=0;iter<100;iter++){let maxChange=0;for(let j=0;j<p;j++){const oldCoeff=coefficients[j];let partialResidual=0;for(let i=0;i<n;i++){let prediction=0;for(let k=0;k<p;k++)k!==j&&(prediction+=coefficients[k]*X[i][k]);partialResidual+=X[i][j]*(y[i]-prediction)}let sumSquares=0;for(let i=0;i<n;i++)sumSquares+=X[i][j]*X[i][j];coefficients[j]=partialResidual>l1Lambda?(partialResidual-l1Lambda)/(sumSquares+l2Lambda):partialResidual<-l1Lambda?(partialResidual+l1Lambda)/(sumSquares+l2Lambda):0,maxChange=Math.max(maxChange,Math.abs(coefficients[j]-oldCoeff))}if(maxChange<1e-6)break}return coefficients}evaluatePolynomial(x){if(!this.coefficients||0===this.coefficients.length)return 0;let result=0;for(let i=0;i<this.coefficients.length;i++){const power=this.selectedPowers[i];result+=this.coefficients[i]*Math.pow(x,power)}return result}setupEventListeners(){this.degreeSlider.addEventListener("input",()=>{this.updateDegreeDisplay(),this.fitPolynomial(),this.updateDisplay(),this.updateChart()}),this.l1RegSlider.addEventListener("input",()=>{this.updateRegularizationDisplay(),this.fitPolynomial(),this.updateDisplay(),this.updateChart()}),this.l2RegSlider.addEventListener("input",()=>{this.updateRegularizationDisplay(),this.fitPolynomial(),this.updateDisplay(),this.updateChart()}),this.showSquaresCheckbox.addEventListener("change",()=>{this.updateOverlay()}),this.generateDataBtn.addEventListener("click",()=>{this.generateNewData()}),this.clearDataBtn.addEventListener("click",()=>{this.clearAllData()})}updateDisplay(){let equationText="y = ";if(this.coefficients&&0!==this.coefficients.length){const terms=[];let hasNonZeroTerms=!1;for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],power=this.selectedPowers[i],isZero=Math.abs(coeff)<1e-6;isZero||(hasNonZeroTerms=!0);let term="";const absCoeff=Math.abs(coeff),sign=coeff>=0?"+":"-";term=0===i?0===power?isZero?"0.00":coeff.toFixed(2):1===power?isZero?"0.00x":`${coeff.toFixed(2)}x`:isZero?`0.00x^{${power}}`:`${coeff.toFixed(2)}x^{${power}}`:0===power?isZero?"+ 0.00":`${sign} ${absCoeff.toFixed(2)}`:1===power?isZero?"+ 0.00x":`${sign} ${absCoeff.toFixed(2)}x`:isZero?`+ 0.00x^{${power}}`:`${sign} ${absCoeff.toFixed(2)}x^{${power}}`,terms.push(term)}hasNonZeroTerms?equationText+=terms.join(" "):equationText="y = 0"}else equationText="y = 0";this.equation.innerHTML=`$$${equationText}$$`,window.MathJax&&MathJax.typesetPromise([this.equation]).catch(err=>console.log(err));const mse=this.calculateMSE(),mae=this.calculateMAE();if(this.mseDisplay.innerHTML=`$$MSE = ${mse.toFixed(2)}$$`,this.maeDisplay.innerHTML=`$$MAE = ${mae.toFixed(2)}$$`,window.MathJax){const elements=[this.maeDisplay,this.mseDisplay];MathJax.typesetPromise(elements).catch(err=>console.log(err))}}updateDisplayPlainText(){let equationText="y = ";if(this.coefficients&&0!==this.coefficients.length){const terms=[];let hasNonZeroTerms=!1;for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],power=this.selectedPowers[i],isZero=Math.abs(coeff)<1e-6;isZero||(hasNonZeroTerms=!0);let term="";const absCoeff=Math.abs(coeff),sign=coeff>=0?"+":"-";term=0===i?0===power?isZero?"0.00":coeff.toFixed(2):1===power?isZero?"0.00x":`${coeff.toFixed(2)}x`:isZero?`0.00x^${power}`:`${coeff.toFixed(2)}x^${power}`:0===power?isZero?"+ 0.00":`${sign} ${absCoeff.toFixed(2)}`:1===power?isZero?"+ 0.00x":`${sign} ${absCoeff.toFixed(2)}x`:isZero?`+ 0.00x^${power}`:`${sign} ${absCoeff.toFixed(2)}x^${power}`,terms.push(term)}hasNonZeroTerms?equationText+=terms.join(" "):equationText="y = 0"}else equationText="y = 0";this.equation.textContent=equationText;const mse=this.calculateMSE(),mae=this.calculateMAE();this.mseDisplay.textContent=`MSE = ${mse.toFixed(2)}`,this.maeDisplay.textContent=`MAE = ${mae.toFixed(2)}`}calculateMSE(){if(0===this.dataPoints.length)return 0;let sumSquaredErrors=0;return this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),error=point.y-predicted;sumSquaredErrors+=error*error}),sumSquaredErrors/this.dataPoints.length}calculateMAE(){if(0===this.dataPoints.length)return 0;let sumAbsoluteErrors=0;return this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),error=Math.abs(point.y-predicted);sumAbsoluteErrors+=error}),sumAbsoluteErrors/this.dataPoints.length}generateNewData(){this.generateTruePolynomial(),this.clearAllData(),this.generateDataPoints(),this.fitPolynomial(),this.updateDisplay(),this.updateChart()}clearAllData(){this.dataPoints=[],this.fitPolynomial(),this.updateDisplay(),this.updateChart()}handleChartClick(event){const canvasPosition=Chart.helpers.getRelativePosition(event,this.chart),x=this.chart.scales.x.getValueForPixel(canvasPosition.x),y=this.chart.scales.y.getValueForPixel(canvasPosition.y);x>=this.xMin&&x<=this.xMax&&y>=this.yMin&&y<=this.yMax&&(this.dataPoints.push({x:x,y:y}),this.fitPolynomial(),this.updateDisplay(),this.updateChart())}updateChart(){this.chart&&(this.chart.data.datasets[0].data=this.dataPoints.map(point=>({x:point.x,y:point.y})),this.chart.data.datasets[1].data=this.generatePolynomialCurveData(),this.chart.update("none"),this.updateOverlay())}generatePolynomialCurveData(){if(!this.coefficients||0===this.coefficients.length)return[];const curvePoints=[],stepSize=(this.xMax-this.xMin)/7500;for(let i=0;i<=7500;i++){const x=this.xMin+i*stepSize,y=this.evaluatePolynomial(x);y>=this.yMin&&y<=this.yMax?curvePoints.push({x:x,y:y}):curvePoints.push({x:x,y:null})}return curvePoints}updateOverlay(){if(!this.overlayCtx)return;this.overlayCtx.clearRect(0,0,this.displayWidth,this.displayHeight);this.dataPoints.length>0&&this.coefficients.length>0&&(this.showSquaresCheckbox.checked||!0)?(this.overlayCanvas.style.visibility="visible",this.showSquaresCheckbox.checked&&this.drawErrorSquares(),this.drawErrorLines()):this.overlayCanvas.style.visibility="hidden"}dataToOverlayCanvas(x,y){if(!this.chart||!this.chart.scales)return{x:0,y:0};return{x:this.chart.scales.x.getPixelForValue(x),y:this.chart.scales.y.getPixelForValue(y)}}drawErrorLines(){this.overlayCtx.strokeStyle="#777777",this.overlayCtx.lineWidth=1,this.overlayCtx.setLineDash([2,2]),this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),pointCanvas=this.dataToOverlayCanvas(point.x,point.y),predictedCanvas=this.dataToOverlayCanvas(point.x,predicted);this.overlayCtx.beginPath(),this.overlayCtx.moveTo(pointCanvas.x,pointCanvas.y),this.overlayCtx.lineTo(predictedCanvas.x,predictedCanvas.y),this.overlayCtx.stroke()}),this.overlayCtx.setLineDash([])}drawErrorSquares(){this.coefficients&&0!==this.coefficients.length&&(this.overlayCtx.fillStyle="rgba(231, 76, 60, 0.15)",this.overlayCtx.strokeStyle="rgba(231, 76, 60, 0.25)",this.overlayCtx.lineWidth=1,this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),error=point.y-predicted,pointCanvas=this.dataToOverlayCanvas(point.x,point.y),predictedCanvas=this.dataToOverlayCanvas(point.x,predicted),squareSizePixels=Math.abs(pointCanvas.y-predictedCanvas.y);squareSizePixels>2&&(this.overlayCtx.beginPath(),error>0?this.overlayCtx.rect(predictedCanvas.x,predictedCanvas.y,squareSizePixels,-squareSizePixels):this.overlayCtx.rect(predictedCanvas.x,predictedCanvas.y,squareSizePixels,squareSizePixels),this.overlayCtx.fill(),this.overlayCtx.stroke())}))}}document.addEventListener("DOMContentLoaded",()=>{new PolynomialRegularizationDemo});