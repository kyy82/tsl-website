class ConvolutionPoolingDemo{constructor(){this.inputCanvas=document.getElementById("input-canvas"),this.convCanvas=document.getElementById("conv-canvas"),this.poolCanvas=document.getElementById("pool-canvas"),this.filterCanvas=document.getElementById("filter-canvas"),this.inputCtx=this.inputCanvas.getContext("2d"),this.convCtx=this.convCanvas.getContext("2d"),this.poolCtx=this.poolCanvas.getContext("2d"),this.filterCtx=this.filterCanvas.getContext("2d"),this.inputSelect=document.getElementById("input-select"),this.filterSelect=document.getElementById("filter-select"),this.poolingSelect=document.getElementById("pooling-select"),this.poolingSizeSlider=document.getElementById("pooling-size"),this.poolingSizeDisplay=document.getElementById("pooling-size-display"),this.filterEditor=document.getElementById("filter-editor"),this.filterInputs=[];for(let t=0;t<3;t++)for(let e=0;e<3;e++)this.filterInputs.push(document.getElementById(`f${t}${e}`));this.inputImage=[],this.currentFilter=[],this.convOutput=[],this.poolOutput=[],this.imageSize=8,this.filterSize=3,this.highlightedCells={input:[],conv:[],pool:[]},this.filters={"edge-vertical":[[-1,0,1],[-2,0,2],[-1,0,1]],"edge-horizontal":[[-1,-2,-1],[0,0,0],[1,2,1]],blur:[[1/9,1/9,1/9],[1/9,1/9,1/9],[1/9,1/9,1/9]],sharpen:[[0,-1,0],[-1,5,-1],[0,-1,0]]},this.inputPatterns={simple:this.createSimplePattern(),"vertical-edges":this.createVerticalEdgePattern(),"horizontal-edges":this.createHorizontalEdgePattern(),checkerboard:this.createCheckerboard(),gradient:this.createGradient()},this.setupEventListeners(),this.setupCanvasInteractivity(),this.initializeDemo()}setupEventListeners(){this.inputSelect.addEventListener("change",(()=>this.updateInput())),this.filterSelect.addEventListener("change",(()=>this.updateFilter())),this.poolingSelect.addEventListener("change",(()=>this.updatePooling())),this.poolingSizeSlider.addEventListener("input",(()=>this.updatePoolingSize())),this.filterInputs.forEach((t=>{t.addEventListener("input",(()=>this.updateCustomFilter()))}))}setupCanvasInteractivity(){this.convCanvas.addEventListener("mousemove",(t=>{const e=this.convCanvas.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top;this.handleConvolutionHover(i,o)})),this.convCanvas.addEventListener("mouseleave",(()=>{this.clearHighlighting()})),this.poolCanvas.addEventListener("mousemove",(t=>{const e=this.poolCanvas.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top;this.handlePoolingHover(i,o)})),this.poolCanvas.addEventListener("mouseleave",(()=>{this.clearHighlighting()}))}handleConvolutionHover(t,e){if(!this.convOutput||0===this.convOutput.length)return;const i=this.convOutput.length,o=this.convCanvas.width/i,l=this.convCanvas.height/i,n=Math.floor(t/o),s=Math.floor(e/l);if(s>=0&&s<i&&n>=0&&n<i){this.clearHighlighting(),this.highlightedCells.conv=[{row:s,col:n}],this.highlightedCells.input=[];for(let t=0;t<this.filterSize;t++)for(let e=0;e<this.filterSize;e++)this.highlightedCells.input.push({row:s+t,col:n+e});this.updateVisualization()}}handlePoolingHover(t,e){if(!this.poolOutput||0===this.poolOutput.length)return;const i=this.poolOutput.length,o=this.poolCanvas.width/i,l=this.poolCanvas.height/i,n=Math.floor(t/o),s=Math.floor(e/l);if(s>=0&&s<i&&n>=0&&n<i){this.clearHighlighting(),this.highlightedCells.pool=[{row:s,col:n}];const t=parseInt(this.poolingSizeSlider.value);this.highlightedCells.conv=[];for(let e=0;e<t;e++)for(let i=0;i<t;i++){const o=s*t+e,l=n*t+i;o<this.convOutput.length&&l<this.convOutput[0].length&&this.highlightedCells.conv.push({row:o,col:l})}this.updateVisualization()}}clearHighlighting(){this.highlightedCells.input=[],this.highlightedCells.conv=[],this.highlightedCells.pool=[],this.updateVisualization()}initializeDemo(){this.currentFilter=this.filters["edge-vertical"],this.updateInput(),this.updateFilter(),this.updatePoolingSize(),this.performConvolution(),this.performPooling(),this.updateVisualization()}createSimplePattern(){const t=[];for(let e=0;e<this.imageSize;e++){t[e]=[];for(let i=0;i<this.imageSize;i++)e===Math.floor(this.imageSize/2)||i===Math.floor(this.imageSize/2)?t[e][i]=1:t[e][i]=0}return t}createVerticalEdgePattern(){const t=[];for(let e=0;e<this.imageSize;e++){t[e]=[];for(let i=0;i<this.imageSize;i++)i<this.imageSize/2?t[e][i]=0:t[e][i]=1}return t}createHorizontalEdgePattern(){const t=[];for(let e=0;e<this.imageSize;e++){t[e]=[];for(let i=0;i<this.imageSize;i++)e<this.imageSize/2?t[e][i]=0:t[e][i]=1}return t}createCheckerboard(){const t=[];for(let e=0;e<this.imageSize;e++){t[e]=[];for(let i=0;i<this.imageSize;i++)t[e][i]=(e+i)%2}return t}createGradient(){const t=[];for(let e=0;e<this.imageSize;e++){t[e]=[];for(let i=0;i<this.imageSize;i++)t[e][i]=i/(this.imageSize-1)}return t}updateInput(){const t=this.inputSelect.value;this.inputImage=this.inputPatterns[t],this.performConvolution(),this.performPooling(),this.updateVisualization()}updateFilter(){const t=this.filterSelect.value;"custom"===t?(this.filterEditor.style.display="block",this.updateCustomFilter()):(this.filterEditor.style.display="none",this.currentFilter=this.filters[t]),this.performConvolution(),this.performPooling(),this.updateVisualization()}updateCustomFilter(){this.currentFilter=[];for(let t=0;t<3;t++){this.currentFilter[t]=[];for(let e=0;e<3;e++){const i=this.filterInputs[3*t+e];this.currentFilter[t][e]=parseFloat(i.value)||0}}"custom"===this.filterSelect.value&&(this.performConvolution(),this.performPooling(),this.updateVisualization())}updatePooling(){this.performPooling(),this.updateVisualization()}updatePoolingSize(){const t=parseInt(this.poolingSizeSlider.value);this.poolingSizeDisplay.textContent=`${t}Ã—${t}`,this.performPooling(),this.updateVisualization()}performConvolution(){if(!this.currentFilter||!this.inputImage)return;const t=this.imageSize,e=this.filterSize,i=t-e+1;this.convOutput=[];for(let t=0;t<i;t++){this.convOutput[t]=[];for(let o=0;o<i;o++){let i=0;for(let l=0;l<e;l++)for(let n=0;n<e;n++){const e=t+l,s=o+n;i+=this.inputImage[e][s]*this.currentFilter[l][n]}this.convOutput[t][o]=i}}}performPooling(){if(!this.convOutput||0===this.convOutput.length)return;const t=parseInt(this.poolingSizeSlider.value),e=this.poolingSelect.value,i=this.convOutput.length,o=Math.floor(i/t);this.poolOutput=[];for(let l=0;l<o;l++){this.poolOutput[l]=[];for(let n=0;n<o;n++){const o=[];for(let e=0;e<t;e++)for(let s=0;s<t;s++){const h=l*t+e,a=n*t+s;h<i&&a<i&&o.push(this.convOutput[h][a])}if("max"===e)this.poolOutput[l][n]=Math.max(...o);else{const t=o.reduce(((t,e)=>t+e),0);this.poolOutput[l][n]=t/o.length}}}}updateVisualization(){this.drawMatrix(this.inputCtx,this.inputImage,this.inputCanvas.width,this.inputCanvas.height,this.highlightedCells.input,-5,5),this.drawMatrix(this.convCtx,this.convOutput,this.convCanvas.width,this.convCanvas.height,this.highlightedCells.conv,-5,5),this.drawMatrix(this.poolCtx,this.poolOutput,this.poolCanvas.width,this.poolCanvas.height,this.highlightedCells.pool,-5,5),this.drawFilter(this.filterCtx,this.currentFilter,this.filterCanvas.width,this.filterCanvas.height,-5,5)}valueToColor(t,e=-5,i=5){const o=Math.max(e,Math.min(i,t));if(0===o)return"rgb(255, 255, 255)";if(o<0){const t=Math.abs(o),e=1/Math.log(4)*Math.log(1+t),i=216.75,l=82.875,n=.098*255;return`rgb(${Math.floor(255*(1-e)+i*e)}, ${Math.floor(255*(1-e)+l*e)}, ${Math.floor(255*(1-e)+n*e)})`}{const t=o,e=1/Math.log(4)*Math.log(1+t),i=0,l=113.985,n=.741*255;return`rgb(${Math.floor(255*(1-e)+i*e)}, ${Math.floor(255*(1-e)+l*e)}, ${Math.floor(255*(1-e)+n*e)})`}}getTextColor(t,e=-5,i=5){const o=Math.max(e,Math.min(i,t));return Math.abs(o)/Math.max(Math.abs(e),Math.abs(i))<.5?"#000":"#fff"}drawMatrix(t,e,i,o,l=[],n=null,s=null){if(!e||0===e.length)return;t.clearRect(0,0,i,o);const h=e.length,a=e[0].length,r=i/a,u=o/h;let c,g;if(null!==n&&null!==s)c=n,g=s;else{c=1/0,g=-1/0;for(let t=0;t<h;t++)for(let i=0;i<a;i++)c=Math.min(c,e[t][i]),g=Math.max(g,e[t][i])}const p=new Set;l.forEach((t=>{p.add(`${t.row},${t.col}`)}));for(let i=0;i<h;i++)for(let o=0;o<a;o++){const l=e[i][o];t.fillStyle=this.valueToColor(l,c,g),t.fillRect(o*r,i*u,r,u),t.strokeStyle="#333",t.lineWidth=1,t.strokeRect(o*r,i*u,r,u);const n=this.getTextColor(l,c,g);t.fillStyle=n,t.font=.3*Math.min(r,u)+"px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(l.toFixed(1),o*r+r/2,i*u+u/2)}l.length>0&&this.drawHighlightOutline(t,l,r,u)}drawHighlightOutline(t,e,i,o){const l=new Set;e.forEach((t=>{l.add(`${t.row},${t.col}`)})),t.strokeStyle="#ff0000",t.lineWidth=2,e.forEach((e=>{const{row:n,col:s}=e,h=s*i,a=n*o;l.has(`${n-1},${s}`)||(t.beginPath(),t.moveTo(h,a),t.lineTo(h+i,a),t.stroke()),l.has(`${n},${s+1}`)||(t.beginPath(),t.moveTo(h+i,a),t.lineTo(h+i,a+o),t.stroke()),l.has(`${n+1},${s}`)||(t.beginPath(),t.moveTo(h,a+o),t.lineTo(h+i,a+o),t.stroke()),l.has(`${n},${s-1}`)||(t.beginPath(),t.moveTo(h,a),t.lineTo(h,a+o),t.stroke())}))}drawFilter(t,e,i,o,l=-5,n=5){if(!e)return;t.clearRect(0,0,i,o);const s=i/3,h=o/3;for(let i=0;i<3;i++)for(let o=0;o<3;o++){const a=e[i][o];t.fillStyle=this.valueToColor(a,l,n),t.fillRect(o*s,i*h,s,h),t.strokeStyle="#000",t.lineWidth=2,t.strokeRect(o*s,i*h,s,h),t.fillStyle=this.getTextColor(a,l,n),t.font=.25*Math.min(s,h)+"px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(a.toFixed(2),o*s+s/2,i*h+h/2)}}}document.addEventListener("DOMContentLoaded",(()=>{new ConvolutionPoolingDemo}));